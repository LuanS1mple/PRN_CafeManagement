@model IEnumerable<Product>
@{
    ViewData["Title"] = "Quản lý ca làm";
}

<div class="container-fluid py-4">

    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h1 class="mb-0">Công thức</h1>
            <p class="text-muted mb-0">Bảng công thức đồ uống</p>
        </div>
        <div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecipe">
                <i class="fa-solid fa-plus"></i> Thêm
            </button>
        </div>
    </div>

    <!-- Filter -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <form class="row g-3 align-items-end"
            asp-controller="Recipe" 
            asp-action="FilterRecipeProduct"
            method="post">
                <div class="col-md-3">
                    <label class="form-label">Tìm kiếm</label>
                    <input type="text" name="Keyword" class="form-control" placeholder="Tên đồ uống" />
                </div>
                <div class="col-md-1 text-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fa-solid fa-magnifying-glass"></i> Search
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Table -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Sản phẩm</th>
                        <th>Price</th>
                        <th>Mô tả</th>
                        <th class="text-end">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach(var item in Model){
                        <tr>
                        <td>@item.ProductName</td>
                        <td>@item.Price</td>
                        <td>@item.Description</td>
                        <td class="text-end">
                                <button type="button" 
                                        class="btn btn-sm btn-outline-info view-recipe-btn" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#detailRecipeModal"
                                        data-product='@System.Text.Json.JsonSerializer.Serialize(item, new System.Text.Json.JsonSerializerOptions { ReferenceHandler = System.Text.Json.Serialization.ReferenceHandler.IgnoreCycles, PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase })'>
                                    <i class="fa-solid fa-eye"></i>
                                </button>

                                <button type="button" class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#editRecipeModal1">
                                    <i class="fa-solid fa-pen"></i>
                                </button>                                
                                <button type="button" class="btn btn-sm btn-outline-danger">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                        </td>
                        </tr>
                    }
                    
                </tbody>
            </table>
        </div>
    </div>

    

    <div class="modal fade" id="addRecipe" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title">Thêm công thức mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form asp-controller="Recipe" asp-action="AddProduct" method="post">
                    <div class="mb-3">
                        <label class="form-label">Tên sản phẩm</label>
                        <input type="text" name="ProductName" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Giá</label>
                        <input type="number" step="0.01" name="Price" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <input type="text" name="Description" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Nguyên liệu</label>
                        <input type="text" name="IngredientName" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Đơn vị định lượng</label>
                        <input type="text" name="Unit" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Số lượng nguyên liệu cần (QuantityNeeded)</label>
                        <input type="number" step="0.01" name="QuantityNeeded" class="form-control" required />
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">Thêm sản phẩm</button>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailRecipeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết công thức</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Tên sản phẩm:</label>
                    <p id="detailProductName" class="mb-0"></p>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Mô tả:</label>
                    <p id="detailDescription" class="mb-0"></p>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Nguyên liệu:</label>
                    <ul id="detailIngredients" class="mb-0"></ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal: Chỉnh sửa công thức -->
<div class="modal fade" id="editRecipeModal1" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title">Chỉnh sửa công thức</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Gửi dữ liệu tới Recipe/EditRecipe -->
                <form asp-controller="Recipe" asp-action="EditRecipe" method="post">

                    <!-- Tên sản phẩm -->
                    <div class="mb-3">
                        <label class="form-label">Tên sản phẩm</label>
                        <input type="text" name="ProductName" class="form-control" value="Trà sữa truyền thống" required />
                    </div>

                    <!-- Nguyên liệu -->
                    <div class="mb-3">
                        <label class="form-label">Nguyên liệu</label>
                        <textarea name="Ingredients" class="form-control" rows="3" required>Trà đen: 100ml, Sữa đặc: 50ml, Đường: 30g, Trân châu: 50g</textarea>
                    </div>

                    <!-- Cách pha -->
                    <div class="mb-3">
                        <label class="form-label">Cách pha</label>
                        <textarea name="Instructions" class="form-control" rows="2" required>Pha trà đen với sữa đặc và đường, thêm trân châu khi hoàn thành.</textarea>
                    </div>

                    <!-- Ghi chú -->
                    <div class="mb-3">
                        <label class="form-label">Ghi chú</label>
                        <textarea name="Note" class="form-control" rows="2">Dùng đá lạnh, không để lâu quá 10 phút.</textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const buttons = document.querySelectorAll('.view-recipe-btn');

    buttons.forEach(btn => {
        btn.addEventListener('click', function() {
            const product = JSON.parse(this.getAttribute('data-product'));

            document.getElementById('detailProductName').innerText = product.productName;
            document.getElementById('detailDescription').innerText = product.description;

            const ul = document.getElementById('detailIngredients');
            ul.innerHTML = '';

            if (product.recipes && product.recipes.length > 0) {
                product.recipes.forEach(r => {
                    const li = document.createElement('li');
                    li.textContent = `${r.ingredient.ingredientName}: ${r.quantityNeeded} ${r.ingredient.unit}`;
                    ul.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = "Chưa có nguyên liệu nào.";
                ul.appendChild(li);
            }
        });
    });
});
</script>



</div>
