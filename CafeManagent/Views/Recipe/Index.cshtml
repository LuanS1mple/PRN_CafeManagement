@model IEnumerable<Product>
@{
    ViewData["Title"] = "Quản lý ca làm";
}

<div class="container-fluid py-4">

    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h1 class="mb-0">Công thức</h1>
            <p class="text-muted mb-0">Bảng công thức đồ uống</p>
        </div>
        <div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecipe">
                <i class="fa-solid fa-plus"></i> Thêm
            </button>
        </div>
    </div>

    <!-- Filter -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <form class="row g-3 align-items-end"
            asp-controller="Recipe" 
            asp-action="FilterRecipeProduct"
            method="post">
                <div class="col-md-3">
                    <label class="form-label">Tìm kiếm</label>
                    <input type="text" name="Keyword" class="form-control" placeholder="Tên đồ uống" />
                </div>
                <div class="col-md-1 text-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fa-solid fa-magnifying-glass"></i> Search
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Table -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Sản phẩm</th>
                        <th>Price</th>
                        <th>Mô tả</th>
                        <th class="text-end">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach(var item in Model){
                        <tr>
                        <td>@item.ProductName</td>
                        <td>@item.Price</td>
                        <td>@item.Description</td>
                        <td class="text-end">
                                <button type="button" 
                                        class="btn btn-sm btn-outline-info view-recipe-btn" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#detailRecipeModal"
                                        data-product='@System.Text.Json.JsonSerializer.Serialize(item, new System.Text.Json.JsonSerializerOptions { ReferenceHandler = System.Text.Json.Serialization.ReferenceHandler.IgnoreCycles, PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase })'>
                                    <i class="fa-solid fa-eye"></i>
                                </button>

                                <button type="button" 
                                        class="btn btn-sm btn-outline-primary me-2 edit-recipe-btn" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#editRecipeModal"
                                        data-product='@System.Text.Json.JsonSerializer.Serialize(item, new System.Text.Json.JsonSerializerOptions { ReferenceHandler = System.Text.Json.Serialization.ReferenceHandler.IgnoreCycles, PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase })'>
                                    <i class="fa-solid fa-pen"></i>
                                </button>

                                <form method="post" asp-controller="Recipe" asp-action="DeleteProduct" class="d-inline">
                                    <input type="hidden" name="id" value="@item.ProductId" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Bạn có chắc muốn xóa sản phẩm này?')">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </form>

                        </td>
                        </tr>
                    }
                    
                </tbody>
            </table>
        </div>
    </div>

    

    <div class="modal fade" id="addRecipe" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title">Thêm công thức mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">

                <form asp-controller="Recipe" asp-action="AddProduct" method="post">
                    <div class="mb-3">
                        <label class="form-label">Tên sản phẩm</label>
                        <input type="text" name="ProductName" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Giá</label>
                        <input type="number" step="0.01" name="Price" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <input type="text" name="Description" class="form-control" />
                    </div>

                    <!-- ================== NGUYÊN LIỆU NHIỀU DÒNG ================== -->
                    <div class="mb-3">
                        <label class="form-label">Nguyên liệu</label>

                        <div id="ingredientContainer">

                            <!-- Dòng nguyên liệu mặc định -->
                            <div class="row g-2 mb-2 ingredient-item">
                                <div class="col-4">
                                    <input type="text" name="Ingredients[0].IngredientName"
                                           class="form-control" placeholder="Tên nguyên liệu" required />
                                </div>

                                <div class="col-3">
                                    <select name="Ingredients[0].Unit" class="form-select" required>
                                        <option value="kg">kg</option>
                                        <option value="l">l</option>
                                        <option value="gram">gram</option>
                                        <option value="ml">ml</option>
                                    </select>
                                </div>

                                <div class="col-3">
                                    <input type="number" step="0.01" name="Ingredients[0].QuantityNeeded"
                                           class="form-control" placeholder="Số lượng" required />
                                </div>

                                <div class="col-2 d-flex">
                                    <button type="button" class="btn btn-success addIngredient w-100">+</button>
                                </div>
                            </div>


                        </div>

                    </div>
                    <!-- ============================================================= -->

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">Thêm sản phẩm</button>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="detailRecipeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết công thức</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Tên sản phẩm:</label>
                    <p id="detailProductName" class="mb-0"></p>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Mô tả:</label>
                    <p id="detailDescription" class="mb-0"></p>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Nguyên liệu:</label>
                    <ul id="detailIngredients" class="mb-0"></ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="editRecipeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title">Chỉnh sửa công thức</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form asp-controller="Recipe" asp-action="EditProduct" method="post">

                    <input type="hidden" name="productId" id="editProductId" />

                    <div class="mb-3">
                        <label class="form-label">Tên sản phẩm</label>
                        <input type="text" name="ProductName" class="form-control" id="editProductName" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <input type="text" name="Description" class="form-control" id="editDescription" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Giá</label>
                        <input type="number" step="0.01" name="Price" class="form-control" id="editPrice" required />
                    </div>

                    <!-- NGUYÊN LIỆU -->
                    <div class="mb-3">
                        <label class="form-label">Nguyên liệu</label>

                        <div id="editIngredientContainer">
                        </div>

                    </div>


                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

@* Load form *@
<script>
document.addEventListener('DOMContentLoaded', function() {
    const buttons = document.querySelectorAll('.view-recipe-btn');

    buttons.forEach(btn => {
        btn.addEventListener('click', function() {
            const product = JSON.parse(this.getAttribute('data-product'));

            document.getElementById('detailProductName').innerText = product.productName;
            document.getElementById('detailDescription').innerText = product.description;

            const ul = document.getElementById('detailIngredients');
            ul.innerHTML = '';

            if (product.recipes && product.recipes.length > 0) {
                product.recipes.forEach(r => {
                    const li = document.createElement('li');
                    li.textContent = `${r.ingredient.ingredientName}: ${r.quantityNeeded} ${r.ingredient.unit}`;
                    ul.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = "Chưa có nguyên liệu nào.";
                ul.appendChild(li);
            }
        });
    });
});
</script>

@* Add *@
<script>
document.addEventListener("DOMContentLoaded", function () {

    const container = document.getElementById("ingredientContainer");

    function updateIndexes() {
        const items = container.querySelectorAll(".ingredient-item");
        items.forEach((item, index) => {
            item.querySelectorAll("input, select").forEach(el => {
                let name = el.getAttribute("name");
                name = name.replace(/\[\d+\]/, `[${index}]`);
                el.setAttribute("name", name);
            });
        });
    }


    container.addEventListener("click", function (e) {

        if (e.target.classList.contains("addIngredient")) {

            const newRow = document.createElement("div");
            newRow.classList.add("row", "g-2", "mb-2", "ingredient-item");

            newRow.innerHTML = `
                <div class="col-4">
                    <input type="text" name="Ingredients[0].IngredientName" class="form-control" placeholder="Tên nguyên liệu" required />
                </div>
                <div class="col-3">
                    <select name="Ingredients[0].Unit" class="form-select" required>
                        <option value="kg">kg</option>
                        <option value="l">l</option>
                        <option value="gram">gram</option>
                        <option value="ml">ml</option>
                    </select>
                </div>
                <div class="col-3">
                    <input type="number" step="0.01" name="Ingredients[0].QuantityNeeded" class="form-control" placeholder="Số lượng" required />
                </div>
                <div class="col-2 d-flex">
                    <button type="button" class="btn btn-danger removeIngredient w-100">🗑</button>
                </div>
            `;


            container.appendChild(newRow);
            updateIndexes();
        }

        if (e.target.classList.contains("removeIngredient")) {
            e.target.closest(".ingredient-item").remove();
            updateIndexes();
        }

    });

});
</script>

@* Edit *@
<script>
document.addEventListener('DOMContentLoaded', function () {

    const editContainer = document.getElementById("editIngredientContainer");

    // Hàm tạo dòng nguyên liệu
    function createEditRow(index, ing = null) {
        return `
            <div class="row g-2 mb-2 ingredient-item">
                <div class="col-4">
                    <input type="text" name="Ingredients[${index}].IngredientName"
                           class="form-control"
                           value="${ing ? ing.ingredient.ingredientName : ""}"
                           placeholder="Tên nguyên liệu" required />
                </div>

                <div class="col-3">
                    <select name="Ingredients[${index}].Unit" class="form-select" required>
                        <option value="kg" ${ing && ing.ingredient.unit == "kg" ? "selected" : ""}>kg</option>
                        <option value="l" ${ing && ing.ingredient.unit == "l" ? "selected" : ""}>l</option>
                        <option value="gram" ${ing && ing.ingredient.unit == "gram" ? "selected" : ""}>gram</option>
                        <option value="ml" ${ing && ing.ingredient.unit == "ml" ? "selected" : ""}>ml</option>
                    </select>
                </div>

                <div class="col-3">
                    <input type="number" step="0.01"
                           name="Ingredients[${index}].QuantityNeeded"
                           class="form-control"
                           value="${ing ? ing.quantityNeeded : ""}"
                           placeholder="Số lượng" required />
                </div>

                <div class="col-2 d-flex">
                    ${index === 0
                        ? `<button type="button" class="btn btn-success addIngredientEdit w-100">+</button>`
                        : `<button type="button" class="btn btn-danger removeIngredientEdit w-100">🗑</button>`
                    }
                </div>
            </div>
        `;
    }

    // Cập nhật lại index
    function updateEditIndexes() {
        const items = editContainer.querySelectorAll(".ingredient-item");
        items.forEach((item, index) => {
            item.querySelectorAll("input, select").forEach(el => {
                let name = el.getAttribute("name");
                name = name.replace(/\[\d+\]/, `[${index}]`);
                el.setAttribute("name", name);
            });

            // Update nút + cho dòng đầu tiên và nút xóa  cho các dòng sau
            const btnContainer = item.querySelector(".col-2");
            if (index === 0) {
                btnContainer.innerHTML = `<button type="button" class="btn btn-success addIngredientEdit w-100">+</button>`;
            } else {
                btnContainer.innerHTML = `<button type="button" class="btn btn-danger removeIngredientEdit w-100">🗑</button>`;
            }
        });
    }

    // Khi bấm nút EDIT
    document.querySelectorAll('.edit-recipe-btn').forEach(btn => {
        btn.addEventListener('click', function () {

            const product = JSON.parse(this.getAttribute('data-product'));

            document.getElementById('editProductId').value = product.productId;
            document.getElementById('editProductName').value = product.productName;
            document.getElementById('editDescription').value = product.description;
            document.getElementById('editPrice').value = product.price;

            editContainer.innerHTML = "";

            if (product.recipes && product.recipes.length > 0) {
                product.recipes.forEach((r, index) => {
                    editContainer.insertAdjacentHTML("beforeend", createEditRow(index, r));
                });
            } else {
                editContainer.insertAdjacentHTML("beforeend", createEditRow(0));
            }
        });
    });

    // Sự kiện click: thêm hoặc xóa dòng
    editContainer.addEventListener("click", function (e) {
        if (e.target.classList.contains("addIngredientEdit")) {
            const index = editContainer.querySelectorAll(".ingredient-item").length;
            editContainer.insertAdjacentHTML("beforeend", createEditRow(index));
            updateEditIndexes();
        }

        if (e.target.classList.contains("removeIngredientEdit")) {
            e.target.closest(".ingredient-item").remove();
            updateEditIndexes();
        }
    });

});
</script>




</div>
