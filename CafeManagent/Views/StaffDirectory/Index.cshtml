@model CafeManagent.dto.response.PagedResult<CafeManagent.dto.response.StaffListItemDto>
@{
    var q = (CafeManagent.dto.response.StaffListQuery)ViewBag.Query ?? new CafeManagent.dto.response.StaffListQuery();
    ViewData["Title"] = "Danh sách nhân viên";

    var totalPages = (int)Math.Ceiling((double)(Model.TotalItems) / Math.Max(1, Model.Size));
    var prevDisabled = Model.Page <= 1 ? "disabled" : "";
    var nextDisabled = Model.Page >= totalPages ? "disabled" : "";
}
<link rel="stylesheet" href="~/css/StaffDirectory.css" />

<div class="container">
    <div class="page-header">
        <div>
            <h2 class="title">Danh sách nhân viên</h2>
            <div class="sub">Quản lý thông tin nhân viên trong công ty</div>
        </div>
        <a class="btn primary" href="@Url.Action("Create","StaffDirectory")">+ Thêm nhân viên</a>
    </div>

    <form method="get" action="@Url.Action("Index","StaffDirectory")" class="toolbar">
        <input class="input search" type="text" name="q.Q" value="@q.Q" placeholder="Tìm theo tên/email..." />
        <select class="input" name="q.Status">
            <option value="" selected="@(q.Status == null ? "selected" : null)">Trạng thái</option>
            <option value="1" selected="@(q.Status == 1 ? "selected" : null)">Đang làm việc</option>
            <option value="2" selected="@(q.Status == 2 ? "selected" : null)">Nghỉ phép</option>
            <option value="3" selected="@(q.Status == 3 ? "selected" : null)">Nghỉ việc</option>
        </select>
        <input type="hidden" name="q.Page" value="1" />
        <input type="hidden" name="q.Size" value="@Model.Size" />
        <button class="btn">Lọc</button>
    </form>

    <div class="card table-card">
        <table class="table">
            <thead>
                <tr>
                    <th style="width:42px;"></th>
                    <th>Avatar</th>
                    <th>Họ tên</th>
                    <th>Email</th>
                    <th>Chức danh</th>
                    <th>Trạng thái</th>
                    <th>Ngày vào làm</th>
                    <th>Hết hạn HĐ</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var s in Model.Items)
                {
                    <tr class="row-link">
                        <td>
                            <input type="checkbox"
                                   onclick="event.stopPropagation(); location.href='@Url.Action("Details","StaffDirectory", new { id = s.StaffId })';" />
                        </td>
                        <td><img src="@s.AvatarUrl?v=@DateTimeOffset.UtcNow.Ticks" class="avatar-sm" /></td>
                        <td>@s.FullName</td>
                        <td>@s.Email</td>
                        <td>@s.Title</td>
                        @{
                            var status = s.Status?.Trim();

                            var (badgeClass, dotClass, selectedVal) = status switch
                            {
                                "Đang làm việc" => ("badge-green", "dot-green", 1),
                                "Nghỉ phép" => ("badge-gray", "dot-gray", 2),
                                "Nghỉ việc" => ("badge-red", "dot-red", 3),
                                _ => ("badge-gray", "dot-gray", 0)
                            };
                        }
                        <td data-staff-id="@s.StaffId">

                            <!-- Dropdown thay đổi trạng thái -->
                            <select class="input js-status-select" data-id="@s.StaffId">
                                <option value="1" selected="@(selectedVal == 1)">Đang làm việc</option>
                                <option value="2" selected="@(selectedVal == 2)">Nghỉ phép</option>
                                <option value="3" selected="@(selectedVal == 3)">Nghỉ việc</option>

                            </select>

                        </td>
                        <td>@(s.JoinDate?.ToString("dd/MM/yyyy"))</td>
                        <td>@(s.ContractEndDate?.ToString("dd/MM/yyyy"))</td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="pager">
            <a class="pager-btn @prevDisabled"
            @(Model.Page <= 1 ? "tabindex=\"-1\" aria-disabled=\"true\"" : "")
               href="@(Model.Page <= 1 ? "#" :
                    Url.Action("Index", new System.Collections.Generic.Dictionary<string, object?>
                    {
                        ["q.Q"] = q.Q,
                        ["q.Status"] = q.Status,
                        ["q.Page"] = Model.Page - 1,
                        ["q.Size"] = Model.Size
                    }))">
                ‹ Previous
            </a>

            <span class="pager-num">@Model.Page / @totalPages</span>

            <a class="pager-btn @nextDisabled"
            @((Model.Page >= totalPages || totalPages == 0) ? "tabindex=\"-1\" aria-disabled=\"true\"" : "")
               href="@((Model.Page >= totalPages || totalPages == 0) ? "#" :
                    Url.Action("Index", new System.Collections.Generic.Dictionary<string, object?>
                    {
                        ["q.Q"] = q.Q,
                        ["q.Status"] = q.Status,
                        ["q.Page"] = Model.Page + 1,
                        ["q.Size"] = Model.Size
                    }))">
                Next ›
            </a>
        </div>

    </div>
    <form id="__af" method="post">
        @Html.AntiForgeryToken()
    </form>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.12/dist/browser/signalr.min.js"></script>
    <!-- JS xử lý inline status + SignalR -->
    <script src="~/js/StaffStatus.js"></script>
}


