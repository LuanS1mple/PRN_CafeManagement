@model IEnumerable<CafeManagent.Models.Task>
@using CafeManagent.Models
@using System.Security.Claims

@{
    ViewData["Title"] = "Danh sách công việc";
    var currentManagerId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    var currentManagerFullName = User.FindFirstValue(ClaimTypes.Name);
}

@section Styles {
    <style>
        .task-status-badge {
            min-width: 100px;
            display: inline-block;
            text-align: center;
        }

        .highlight-update {
            animation: highlight-yellow 2s ease-out;
        }

        @@keyframes highlight-yellow {
            0% {
                background-color: #fffb00;
            }

            100% {
                background-color: transparent;
            }
        }
    </style>
}

<div class="border-bottom bg-white">
    <div class="container-fluid px-4 py-3 d-flex align-items-center gap-3">
        <div class="p-2 bg-primary rounded-3 text-white fw-bold fs-5 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">📋</div>
        <div>
            <h1 class="fs-4 fw-semibold mb-0">@ViewData["Title"]</h1>
            <p class="text-muted mb-0">Theo dõi các nhiệm vụ được giao cho nhân viên</p>
        </div>
    </div>
</div>

<div class="container-fluid px-4 py-4">

    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">

        <form id="searchForm" method="get" asp-action="Index" asp-controller="Task" class="d-flex flex-wrap align-items-center gap-3">
            <input type="hidden" name="StatusFilter" id="hiddenStatusFilter" value="@Context.Request.Query["StatusFilter"]" />

            <input type="text" name="searchString" value="@Context.Request.Query["searchString"]"
                   placeholder="Tìm theo tên NV, QL, công việc..." class="form-control" style="width: 280px;" />

            <div class="dropdown">
                @{
                    var currentStatus = Context.Request.Query["StatusFilter"].ToString();
                    var statusText = "Trạng thái";
                    if (!string.IsNullOrEmpty(currentStatus))
                    {
                        switch (currentStatus)
                        {
                            case "0": statusText = "Chưa bắt đầu"; break;
                            case "1": statusText = "Đang tiến hành"; break;
                            case "2": statusText = "Hoàn thành"; break;
                            case "3": statusText = "Đã hủy"; break;
                            case "4": statusText = "Hết hạn"; break;
                            case "5": statusText = "Làm lại"; break;
                            case "6": statusText = "Chờ xác nhận"; break;
                        }
                    }
                }
                <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center justify-content-between"
                        type="button" data-bs-toggle="dropdown" style="min-width: 160px;">
                    @statusText
                </button>
                <ul class="dropdown-menu shadow">
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="applyStatusFilter('0')">Chưa bắt đầu</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="applyStatusFilter('1')">Đang tiến hành</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="applyStatusFilter('2')">Hoàn thành</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="applyStatusFilter('3')">Đã hủy</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="applyStatusFilter('4')">Hết hạn</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="applyStatusFilter('5')">Làm lại</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="applyStatusFilter('6')">Chờ xác nhận</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-muted" href="javascript:void(0)" onclick="applyStatusFilter('')">Tất cả trạng thái</a></li>
                </ul>
            </div>

            <div class="d-flex align-items-center gap-1">
                <label for="startDate" class="form-label text-sm fw-medium text-nowrap mb-0">Từ:</label>
                <input type="date" id="startDate" name="startDate" value="@Context.Request.Query["startDate"]" class="form-control" />
            </div>

            <div class="d-flex align-items-center gap-1">
                <label for="endDate" class="form-label text-sm fw-medium text-nowrap mb-0">Đến:</label>
                <input type="date" id="endDate" name="endDate" value="@Context.Request.Query["endDate"]" class="form-control" />
            </div>

            <button type="submit" class="btn btn-primary">Lọc</button>
        </form>

        <a asp-action="Create" asp-controller="Task" class="btn btn-primary">+ Thêm công việc</a>
    </div>

    <div class="table-responsive bg-white shadow-sm rounded">
        <table class="table table-hover table-striped mb-0">
            <thead class="table-light">
                <tr>
                    <th class="px-3 py-3 text-start">Mã công việc</th>
                    <th class="px-3 py-3 text-start">Tên công việc</th>
                    <th class="px-3 py-3 text-start">Mô tả</th>
                    <th class="px-3 py-3 text-start">Nhân viên</th>
                    <th class="px-3 py-3 text-start">Người quản lý</th>
                    <th class="px-3 py-3 text-start">Thời gian bắt đầu</th>
                    <th class="px-3 py-3 text-start">Thời hạn</th>
                    <th class="px-3 py-3 text-start text-nowrap">Trạng thái</th>
                    <th class="px-3 py-3 text-start">Chức năng</th>
                </tr>
            </thead>
            <tbody id="tasksTableBody">
                @if (Model != null && Model.Any())
                {
                    foreach (var task in Model)
                    {
                        <tr class="align-middle" id="task-row-@task.TaskId">
                            <td class="px-3 py-3 cell-task-id">@task.TaskId</td>
                            <td class="px-3 py-3 fw-medium text-dark cell-task-name">@((task.Tasktype?.TaskName) ?? "—")</td>
                            <td class="px-3 py-3 text-muted cell-task-description">@((task.Tasktype?.Description) ?? "—")</td>
                            <td class="px-3 py-3 cell-task-staff">@((task.Staff?.FullName) ?? "—")</td>
                            <td class="px-3 py-3 cell-task-manager">@((task.Manager?.FullName) ?? "—")</td>
                            <td class="px-3 py-3 cell-task-assign">@((task.AssignTime?.ToString("dd/MM/yyyy HH:mm")) ?? "—")</td>
                            <td class="px-3 py-3 cell-task-due">@((task.DueTime?.ToString("dd/MM/yyyy HH:mm")) ?? "—")</td>
                            <td class="px-3 py-3 text-nowrap cell-task-status">
                                @{
                                    string statusLabel = "Không xác định";
                                    string statusClass = "badge rounded-pill task-status-badge ";
                                    switch (task.Status)
                                    {
                                        case 0: statusLabel = "Chưa bắt đầu"; statusClass += "bg-primary"; break;
                                        case 1: statusLabel = "Đang tiến hành"; statusClass += "bg-warning text-dark"; break;
                                        case 2: statusLabel = "Hoàn thành"; statusClass += "bg-success"; break;
                                        case 3: statusLabel = "Đã hủy"; statusClass += "bg-danger"; break;
                                        case 4: statusLabel = "Hết hạn"; statusClass += "bg-dark"; break;
                                        case 5: statusLabel = "Làm lại"; statusClass += "bg-info"; break;
                                        case 6: statusLabel = "Chờ xác nhận"; statusClass += "bg-secondary"; break;
                                    }
                                }
                                <span class="@statusClass">@statusLabel</span>
                            </td>
                            <td class="px-3 py-3 text-end cell-task-actions">
                                <a asp-action="Edit" asp-controller="Task" asp-route-id="@task.TaskId"
                                   class="btn btn-sm btn-info text-white">Chi tiết</a>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr id="no-tasks-row"><td colspan="9" class="text-center text-muted py-4">Không có công việc nào được hiển thị.</td></tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="~/lib/signalr/signalr.min.js"></script>
    <script>

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/taskHub") // FIX: đúng URL
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();

        async function startConnection() {
            try { await connection.start(); }
            catch { setTimeout(startConnection, 3000); }
        }

        connection.on("ReceiveTaskUpdate", function (task) {
            console.log("Realtime Task Update:", task);

            const noTaskRow = document.getElementById('no-tasks-row');
            if (noTaskRow) noTaskRow.remove();

            let row = document.getElementById(`task-row-${task.taskId}`);

            if (task.isDeleted) {
                if (row) row.remove();
                return;
            }

            if (row) {
                updateTaskRow(row, task);
                row.classList.add("highlight-update");
                setTimeout(() => row.classList.remove("highlight-update"), 1200);
            } else {
                const tableBody = document.getElementById('tasksTableBody');
                tableBody.insertAdjacentHTML("afterbegin", createTaskRowHtml(task));

                row = document.getElementById(`task-row-${task.taskId}`);
                if (row) {
                    row.classList.add("highlight-update");
                    setTimeout(() => row.classList.remove("highlight-update"), 1200);
                }
            }
        });

        startConnection();
        connection.onclose(startConnection);

        function getStatusBadgeInfo(status) {
            let statusLabel = "Không xác định";
            let statusClass = "badge rounded-pill task-status-badge ";
            switch (status) {
                case 0: statusLabel = "Chưa bắt đầu"; statusClass += "bg-primary"; break;
                case 1: statusLabel = "Đang tiến hành"; statusClass += "bg-warning text-dark"; break;
                case 2: statusLabel = "Hoàn thành"; statusClass += "bg-success"; break;
                case 3: statusLabel = "Đã hủy"; statusClass += "bg-danger"; break;
                case 4: statusLabel = "Hết hạn"; statusClass += "bg-dark"; break;
                case 5: statusLabel = "Làm lại"; statusClass += "bg-info"; break;
                case 6: statusLabel = "Chờ xác nhận"; statusClass += "bg-secondary"; break;
            }
            return { statusLabel, statusClass };
        }

        function formatDateTime(dt) {
            if (!dt) return "—";
            const d = new Date(dt);
            return d.toLocaleString('vi-VN', {
                day: "2-digit", month: "2-digit", year: "numeric",
                hour: "2-digit", minute: "2-digit"
            });
        }

        function updateTaskRow(row, task) {
            const { statusLabel, statusClass } = getStatusBadgeInfo(task.status);
            row.querySelector('.cell-task-name').textContent = task.tasktypeName ?? "—";
            row.querySelector('.cell-task-description').textContent = task.description ?? "—";
            row.querySelector('.cell-task-staff').textContent = task.staffName ?? "—";
            row.querySelector('.cell-task-manager').textContent = task.managerName ?? "—";
            row.querySelector('.cell-task-assign').textContent = formatDateTime(task.assignTime);
            row.querySelector('.cell-task-due').textContent = formatDateTime(task.dueTime);
            row.querySelector('.cell-task-status').innerHTML = `<span class="${statusClass}">${statusLabel}</span>`;
        }

        function createTaskRowHtml(task) {
            const { statusLabel, statusClass } = getStatusBadgeInfo(task.status);
            return `
                <tr class="align-middle" id="task-row-${task.taskId}">
                    <td class="px-3 py-3">${task.taskId}</td>
                    <td class="px-3 py-3 fw-medium text-dark cell-task-name">${task.tasktypeName ?? "—"}</td>
                    <td class="px-3 py-3 text-muted cell-task-description">${task.description ?? "—"}</td>
                    <td class="px-3 py-3 cell-task-staff">${task.staffName ?? "—"}</td>
                    <td class="px-3 py-3 cell-task-manager">${task.managerName ?? "—"}</td>
                    <td class="px-3 py-3 cell-task-assign">${formatDateTime(task.assignTime)}</td>
                    <td class="px-3 py-3 cell-task-due">${formatDateTime(task.dueTime)}</td>
                    <td class="px-3 py-3 text-nowrap cell-task-status"><span class="${statusClass}">${statusLabel}</span></td>
                    <td class="px-3 py-3 text-end">
                        <a href="/Task/Edit/${task.taskId}" class="btn btn-sm btn-info text-white">Chi tiết</a>
                    </td>
                </tr>
            `;
        }

        function applyStatusFilter(statusValue) {
            document.getElementById('hiddenStatusFilter').value = statusValue;
            document.getElementById('searchForm').submit();
        }
    </script>
}
