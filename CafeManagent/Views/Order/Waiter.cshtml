@using CafeManagent.dto.response.OrderModuleDTO
@model dynamic
@{
    ViewData["Title"] = "Màn hình Waiter";
    var activeOrders = ViewBag.ActiveOrders as List<OrderDto> ?? new List<OrderDto>();
    // Sắp xếp đơn hàng: Status giảm dần (2, 1, 0), OrderId tăng dần (đơn cũ hơn lên trước)
    var sortedOrders = activeOrders
        .OrderByDescending(o => o.Status)
        .ThenBy(o => o.OrderId)
        .ToList();
}

<h2 class="text-center mb-4">Màn hình Waiter </h2>
<hr />

<div class="d-flex justify-content-between mb-3">
    <a href="/Order/addorder" class="btn btn-success">
        <i class="fa-solid fa-plus me-2"></i> Tạo Đơn Mới
    </a>
    <a href="/Order/AllHistory" class="btn btn-secondary">
        <i class="fa-solid fa-file-lines me-2"></i>Xem Tất Cả Order Đã Tạo
    </a>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <form id="waiterFilterForm">
            <div class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label class="form-label">Tìm kiếm (Tên KH, Note, ID):</label>
                    <input type="text" name="query" id="waiter-query" class="form-control" placeholder="Nhập từ khóa..." />
                </div>
                <div class="col-md-5">
                    <label class="form-label">Lọc theo Trạng thái:</label>
                    <select name="statusFilter" id="waiter-status-filter" class="form-select">
                        <option value="99">Tất cả (Chờ, Chuẩn bị, Sẵn sàng)</option>
                        <option value="2">Đã sẵn sàng</option>
                        <option value="1">Đang chuẩn bị</option>
                        <option value="0">Chờ</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="button" id="waiter-search-btn" class="btn btn-primary w-100"><i class="fa-solid fa-filter me-1"></i> Lọc</button>
                </div>
            </div>
        </form>
    </div>
</div>
<hr />


<div class="row">
    <div class="col-md-12">
        <div class="card bg-light mb-4 shadow-sm">
            <div class="card-header bg-dark text-white fw-bold">Đơn Hàng Đang Theo Dõi</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col" style="width: 5%;">ID</th>
                                <th scope="col" style="width: 20%;">Khách hàng</th>
                                <th scope="col" style="width: 15%;">Tổng tiền</th>
                                <th scope="col" style="width: 20%;">Thời gian</th>
                                <th scope="col" style="width: 15%;">Trạng thái</th>
                                <th scope="col" style="width: 25%;" class="text-end">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="active-list-waiter">
                            @if (sortedOrders.Any())
                            {
                                @foreach (var order in sortedOrders)
                                {
                                    <tr class="order-row" id="order-@order.OrderId" data-status="@(order.Status ?? 0)">
                                        <th scope="row">#@order.OrderId</th>
                                        <td>@order.CustomerName</td>
                                        <td><strong data-amount="@order.TotalAmount">@order.TotalAmount.ToString() VND</strong></td>
                                        <td>@order.OrderTime</td>
                                        <td>
                                            @{
                                                string badgeClass = (order.Status == 0) ? "bg-warning text-dark" : (order.Status == 1) ? "bg-primary" : (order.Status == 2) ? "bg-success" : "";
                                            }
                                            <span class="badge @badgeClass">@order.StatusText</span>
                                        </td>
                                        <td class="text-end" data-order-status="@(order.Status ?? 0)">
                                            <a href="/Order/Details/@order.OrderId" class="btn btn-sm btn-info me-1" title="Xem chi tiết"><i class="fa-solid fa-eye"></i></a>
                                            @if (order.Status == 0)
                                            {
                                                <button class="btn btn-sm btn-danger cancel-btn" data-id="@order.OrderId" data-bs-toggle="modal" data-bs-target="#confirmCancelModal" title="Hủy đơn"><i class="fa-solid fa-xmark"></i> Hủy</button>
                                            }
                                            else if (order.Status == 2)
                                            {
                                                <button class="btn btn-sm btn-success confirm-btn" data-id="@order.OrderId" data-bs-toggle="modal" data-bs-target="#confirmWaiterModal" title="Xác nhận giao hàng & thanh toán"><i class="fa-solid fa-check"></i> Xác nhận</button>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
                @if (!sortedOrders.Any())
                {
                    <p class="text-muted text-center mt-3" id="active-empty-waiter">Không có đơn hàng nào đang hoạt động.</p>
                }
            </div>
        </div>
    </div>
</div>

@* Modals *@
<div class="modal fade" id="confirmWaiterModal" tabindex="-1" aria-labelledby="confirmWaiterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="confirmWaiterModalLabel"><i class="fa-solid fa-check-circle me-2"></i>Xác nhận hoàn thành</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn xác nhận đã giao và **thanh toán** đơn hàng **#<span id="waiter-order-id-confirm"></span>** này không?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-success" id="confirmWaiterBtnAction">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmCancelModal" tabindex="-1" aria-labelledby="confirmCancelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmCancelModalLabel"><i class="fa-solid fa-exclamation-triangle me-2"></i>Xác nhận hủy đơn</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn **hủy** đơn hàng **#<span id="waiter-order-id-cancel"></span>** này không?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
                <button type="button" class="btn btn-danger" id="confirmCancelBtnAction">Hủy đơn</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
    <script>

        const orderHub = new signalR.HubConnectionBuilder()
            .withUrl("/orderHub")
            .build();
        orderHub.start().then(() => console.log("Đã kết nối tới OrderHub")).catch(err => console.error("Lỗi kết nối OrderHub:", err));

        function renderOrderCard(orderDto, role) {
            const customerName = orderDto.customerName && orderDto.customerName.trim() !== '' && orderDto.customerName !== 'Khách lẻ' ? orderDto.customerName : 'Khách vãng lai';

            let buttonHtml = '';
            let badgeClass = '';
            const status = orderDto.status ?? 0;
            const orderId = orderDto.orderId ?? 0;
            const formattedAmount = (orderDto.totalAmount ?? 0).toLocaleString('vi-VN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            const statusTextDisplay = orderDto.statusText;

            if (role === 'Waiter') {
                if (status === 0) {
                    buttonHtml = `<button class="btn btn-sm btn-danger cancel-btn" data-id="${orderId}" data-bs-toggle="modal" data-bs-target="#confirmCancelModal" title="Hủy đơn"><i class="fa-solid fa-xmark"></i> Hủy</button>`;
                    badgeClass = 'bg-warning text-dark';
                } else if (status === 2) {
                    buttonHtml = `<button class="btn btn-sm btn-success confirm-btn" data-id="${orderId}" data-bs-toggle="modal" data-bs-target="#confirmWaiterModal" title="Xác nhận giao hàng & thanh toán"><i class="fa-solid fa-check"></i> Xác nhận</button>`;
                    badgeClass = 'bg-success';
                } else if (status === 1) {
                    badgeClass = 'bg-primary';
                } else {
                    buttonHtml = '';
                    badgeClass = (status === -1) ? 'bg-danger' : (status === -2) ? 'bg-info' : 'bg-dark';
                }
            }

            return `
                <tr class="order-row" id="order-${orderId}" data-status="${status}">
                    <th scope="row">#${orderId}</th>
                    <td>${customerName}</td>
                    <td><strong data-amount="${orderDto.totalAmount}">${formattedAmount} VND</strong></td>
                    <td>${orderDto.orderTime}</td>
                    <td>
                        <span class="badge ${badgeClass}">${statusTextDisplay}</span>
                    </td>
                    <td class="text-end" data-order-status="${status}">
                        <a href="/Order/Details/${orderId}" class="btn btn-sm btn-info me-1" title="Xem chi tiết"><i class="fa-solid fa-eye"></i></a>
                        ${buttonHtml}
                    </td>
                </tr>
            `;
        }

        function sortAndInsertWaiter(orderDto) {
            const list = $("#active-list-waiter");
            const cardHtml = renderOrderCard(orderDto, 'Waiter');
            const newStatus = orderDto.status ?? 0;
            const newOrderId = orderDto.orderId ?? 0;


            $(`#order-${newOrderId}`).remove();

            if (newStatus < 0 || newStatus > 2) {
                if (list.children('.order-row').length === 0) {
                    list.parent().parent().parent().append('<p class="text-muted text-center mt-3" id="active-empty-waiter">Không có đơn hàng nào đang hoạt động.</p>');
                }
                return;
            }

            let inserted = false;
            list.children('.order-row').each(function() {
                const $currentOrder = $(this);
                const currentStatus = parseInt($currentOrder.data('status')) || 0;
                const currentOrderId = parseInt($currentOrder.attr('id').replace('order-', '')) || 0;
                if (newStatus > currentStatus) {
                    $currentOrder.before(cardHtml);
                    inserted = true;
                    return false;
                }
                else if (newStatus === currentStatus) {
                    if (newOrderId < currentOrderId) {
                        $currentOrder.before(cardHtml);
                        inserted = true;
                        return false;
                    }
                }
            });

            if (!inserted) {

                list.append(cardHtml);
            }

            $("#active-empty-waiter").remove();
        }

        let isFilteringWaiter = false;

        function checkIsFilteringWaiter() {
            const query = $('#waiter-query').val().trim();
            const status = $('#waiter-status-filter').val();
            isFilteringWaiter = query !== '' || status !== '99';
            return isFilteringWaiter;
        }

        async function filterAndSearchWaiter() {
            const query = $('#waiter-query').val().trim();
            const status = $('#waiter-status-filter').val();

            checkIsFilteringWaiter();

            const apiUrl = "/Order/SearchActiveOrdersApi";
            const params = new URLSearchParams();
            params.append('query', query);

            if (status === '99') {
                params.append('statusFilter', '0');
                params.append('statusFilter', '1');
                params.append('statusFilter', '2');
            } else {
                params.append('statusFilter', status);
            }

            const url = `${apiUrl}?${params.toString()}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Lỗi khi tải dữ liệu lọc');
                }
                const data = await response.json();

                const tbody = $('#active-list-waiter');
                tbody.empty();
                $("#active-empty-waiter").remove();

                let activeOrders = data.orders.filter(o => o.status >= 0 && o.status <= 2);
                activeOrders.sort((a, b) => {
                    if (b.status !== a.status) {
                        return b.status - a.status;
                    }
                    return a.orderId - b.orderId;
                });

                if (activeOrders.length > 0) {
                    activeOrders.forEach(order => {
                        tbody.append(renderOrderCard(order, 'Waiter'));
                    });
                } else {
                    tbody.parent().parent().parent().append('<p class="text-muted text-center mt-3" id="active-empty-waiter">Không có đơn hàng nào đang hoạt động.</p>');
                }

            } catch (error) {
                console.error("Fetch error:", error);
                alert("Đã xảy ra lỗi khi tìm kiếm!");
            }
        }

        $('#waiter-search-btn').click(filterAndSearchWaiter);

        $('#waiter-query').keypress(function(e) {
            if(e.which === 13) {
                e.preventDefault();
                filterAndSearchWaiter();
            }
        });

        $('#waiter-status-filter').change(filterAndSearchWaiter);

        let selectedOrderId = null;

        // Gắn sự kiện lấy ID cho cả hai modal khi chuẩn bị mở
        $('#confirmWaiterModal').on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget);
            selectedOrderId = button.data('id');
            $('#waiter-order-id-confirm').text(selectedOrderId);
        });

        $('#confirmCancelModal').on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget);
            selectedOrderId = button.data('id');
            $('#waiter-order-id-cancel').text(selectedOrderId);
        });

        // THÊM: Reset selectedOrderId khi Modal đóng hoàn toàn
        $('#confirmWaiterModal, #confirmCancelModal').on('hidden.bs.modal', function () {
            selectedOrderId = null;
        });


        $("#confirmWaiterBtnAction").click(function() {
            if (selectedOrderId) {
                $.post("/Order/ConfirmByWaiter", { id: selectedOrderId })
                    .fail(function() {
                        alert("Lỗi kết nối máy chủ khi xác nhận!");
                    });

               
                $(this).blur();

                $('#confirmWaiterModal').modal('hide');
            }
        });

        $("#confirmCancelBtnAction").click(function() {
            if (selectedOrderId) {
                $.post("/Order/Cancel", { id: selectedOrderId })
                    .fail(function() {
                        alert("Lỗi kết nối máy chủ khi hủy đơn!");
                    });

                // 🛠️ FIX ARIA: Buộc nút mất focus trước khi ẩn modal
                $(this).blur();

                $('#confirmCancelModal').modal('hide');
            }
        });


        // --- SignalR Real-time Updates ---

        orderHub.on("OrderCreated", (orderDto) => {
            const status = orderDto.status ?? 0;
            console.log(`Đã nhận được order mới: #${orderDto.orderId} (Status: ${status})`);

            if (status === 0) {
                if (!checkIsFilteringWaiter()) {
                    sortAndInsertWaiter(orderDto);
                } else {
                    filterAndSearchWaiter();
                }
            }
        });

        orderHub.on("OrderPreparing", (orderDto) => {
            if (!checkIsFilteringWaiter()) {
                sortAndInsertWaiter(orderDto);
            } else {
                filterAndSearchWaiter();
            }
        });

        orderHub.on("OrderReady", (orderDto) => {
            if (!checkIsFilteringWaiter()) {
                sortAndInsertWaiter(orderDto);
            } else {
                filterAndSearchWaiter();
            }
        });

        orderHub.on("OrderConfirmed", (orderDto) => {
            $(`#order-${orderDto.orderId}`).fadeOut(300, function() {
                $(this).remove();
                if ($("#active-list-waiter").children('.order-row').length === 0 && !checkIsFilteringWaiter()) {
                    $("#active-list-waiter").parent().parent().parent().append('<p class="text-muted text-center mt-3" id="active-empty-waiter">Không có đơn hàng nào đang hoạt động.</p>');
                }
            });
        });

        orderHub.on("OrderCanceled", (orderDto) => {
            $(`#order-${orderDto.orderId}`).fadeOut(300, function() {
                $(this).remove();
                if ($("#active-list-waiter").children('.order-row').length === 0 && !checkIsFilteringWaiter()) {
                    $("#active-list-waiter").parent().parent().parent().append('<p class="text-muted text-center mt-3" id="active-empty-waiter">Không có đơn hàng nào đang hoạt động.</p>');
                }
            });
        });

        orderHub.on("OrderRefunded", (orderDto) => {
            $(`#order-${orderDto.orderId}`).fadeOut(300, function() {
                $(this).remove();
            });
        });

        window.addEventListener("pageshow", function (event) {
            if (event.persisted || performance.getEntriesByType("navigation")[0].type === "back_forward") {
                if (typeof orderHub !== "undefined") {
                    if (orderHub.state !== signalR.HubConnectionState.Connected) {
                        orderHub.start()
                            .then(() => console.log(" SignalR reconnected"))
                            .catch(() => {
                                console.log(" Reconnect failed → reload page");
                                window.location.reload();
                            });
                    }
                } else {
                    window.location.reload();
                }
            }
        });
    </script>
}