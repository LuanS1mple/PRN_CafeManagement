@{
    ViewData["Title"] = "Waiter View";
    var waitingOrders = (List<CafeManagent.dto.order.OrderDto>)ViewBag.Waiting;
    var preparingOrders = (List<CafeManagent.dto.order.OrderDto>)ViewBag.Preparing;
    var readyOrders = (List<CafeManagent.dto.order.OrderDto>)ViewBag.Ready;
}

<h2 class="text-center mb-4">Màn hình Waiter 🧑‍🍳</h2>

<div class="d-flex justify-content-end mb-3">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createOrderModal">
        <i class="fa-solid fa-plus me-2"></i>Tạo Đơn Mới
    </button>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card bg-light mb-4 shadow-sm">
            <div class="card-header bg-warning text-white fw-bold">Đang Chờ (Waiting)</div>
            <div class="card-body" id="waiting-list">
                @if (waitingOrders.Any())
                {
                    @foreach (var order in waitingOrders)
                    {
                        @Html.Partial("_OrderCardPartial", order, new ViewDataDictionary(ViewData) { { "Role", "Waiter" } })
                    }
                }
                else
                {
                    <p class="text-muted text-center" id="waiting-empty">Không có đơn nào.</p>
                }
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card bg-light mb-4 shadow-sm">
            <div class="card-header bg-primary text-white fw-bold">Đang Chuẩn Bị (Preparing)</div>
            <div class="card-body" id="preparing-list">
                @if (preparingOrders.Any())
                {
                    @foreach (var order in preparingOrders)
                    {
                        @Html.Partial("_OrderCardPartial", order, new ViewDataDictionary(ViewData) { { "Role", "Waiter" } })
                    }
                }
                else
                {
                    <p class="text-muted text-center" id="preparing-empty">Không có đơn nào.</p>
                }
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card bg-light mb-4 shadow-sm">
            <div class="card-header bg-success text-white fw-bold">Đã Sẵn Sàng (Ready)</div>
            <div class="card-body" id="ready-list">
                @if (readyOrders.Any())
                {
                    @foreach (var order in readyOrders)
                    {
                        @Html.Partial("_OrderCardPartial", order, new ViewDataDictionary(ViewData) { { "Role", "Waiter" } })
                    }
                }
                else
                {
                    <p class="text-muted text-center" id="ready-empty">Không có đơn nào.</p>
                }
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createOrderModal" tabindex="-1" aria-labelledby="createOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createOrderModalLabel">Tạo Đơn Hàng Mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createOrderForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="customerNote" class="form-label">Tên khách/Ghi chú</label>
                        <input type="text" class="form-control" id="customerNote" name="Note" required>
                    </div>
                    <div class="mb-3">
                        <label for="orderPrice" class="form-label">Tổng tiền đơn (Test)</label>
                        <input type="number" step="0.01" class="form-control" id="orderPrice" name="OrderPrice" value="50.00" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-primary">Tạo Đơn</button>
                </div>
            </form>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        const orderHub = new signalR.HubConnectionBuilder()
            .withUrl("/orderHub")
            .build();

        orderHub.start().then(() => console.log("Connected to OrderHub")).catch(err => console.error(err));

        // Hàm chung để render Order Card
        function renderOrderCard(order, role) {
            let buttonHtml = '';
            if (role === 'Waiter') {
                if (order.status === 0) { // Waiting
                    buttonHtml = `
                        <button class="btn btn-sm btn-danger cancel-btn" data-id="${order.orderId}">Hủy</button>
                    `;
                } else if (order.status === 2) { // Ready
                    buttonHtml = `
                        <button class="btn btn-sm btn-success confirm-btn" data-id="${order.orderId}">
                            <i class="fa-solid fa-check me-1"></i> Confirm
                        </button>
                    `;
                }
            }

            return `
                <div class="card mb-2" id="order-${order.orderId}">
                    <div class="card-body p-2">
                        <h6 class="card-title mb-1">#${order.orderId} - ${order.customerName}</h6>
                        <p class="card-text mb-1"><small class="text-muted">${order.orderTime}</small></p>
                        <p class="card-text mb-1"><strong>${order.totalAmount.toLocaleString('vi-VN')} VND</strong></p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge ${order.status === 0 ? 'bg-warning' : order.status === 1 ? 'bg-primary' : 'bg-success'}">${order.statusText}</span>
                            <div>
                                <a href="/Order/Details/${order.orderId}" class="btn btn-sm btn-info me-1">Xem chi tiết</a>
                                ${buttonHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Xử lý tạo đơn hàng
        $("#createOrderForm").submit(function(e) {
            e.preventDefault();
            const formData = $(this).serialize();
            $.post("/Order/Create", formData)
                .done(function(response) {
                    if (response.success) {
                        // SignalR sẽ xử lý việc thêm đơn hàng vào UI, chỉ cần đóng modal và thông báo
                        $("#createOrderModal").modal('hide');
                        alert("Tạo đơn hàng thành công!");
                        // reset form
                        $("#createOrderForm")[0].reset();
                    } else {
                        alert("Lỗi khi tạo đơn hàng.");
                    }
                });
        });

        // Xử lý Hủy đơn hàng (Waiting - Status 0)
        $(document).on('click', '.cancel-btn', function() {
            if (!confirm("Bạn có chắc muốn HỦY đơn hàng này?")) return;
            const id = $(this).data('id');
            $.post("/Order/Cancel", { id: id })
                .done(function(response) {
                    if (response.success) {
                        // SignalR sẽ xử lý việc xóa/cập nhật trạng thái
                        alert(`Đơn hàng #${id} đã được hủy!`);
                    } else {
                        alert("Lỗi khi hủy đơn hàng.");
                    }
                });
        });

        // Xử lý Confirm (Ready - Status 2)
        $(document).on('click', '.confirm-btn', function() {
            if (!confirm("Xác nhận đã giao hàng và hoàn tất đơn?")) return;
            const id = $(this).data('id');
            $.post("/Order/ConfirmByWaiter", { id: id })
                .done(function(response) {
                    if (response.success) {
                        // SignalR sẽ xử lý việc di chuyển đơn
                        alert(`Đơn hàng #${id} đã được xác nhận hoàn tất!`);
                    } else {
                        alert("Lỗi khi xác nhận đơn hàng.");
                    }
                });
        });


        // --- SignalR Real-time Updates ---

        // 1. OrderCreated: Đơn mới tạo -> Cột Waiting
        orderHub.on("OrderCreated", (orderDto) => {
            const list = $("#waiting-list");
            const card = renderOrderCard(orderDto, 'Waiter');
            list.prepend(card); // Thêm lên đầu danh sách
            $("#waiting-empty").remove(); // Xóa thông báo rỗng nếu có
        });

        // 2. OrderPreparing: Đơn chuyển sang Preparing -> Di chuyển từ Waiting sang Preparing
        orderHub.on("OrderPreparing", (orderId) => {
            const card = $(`#order-${orderId}`);
            const list = $("#preparing-list");
            card.find('.badge').removeClass('bg-warning').addClass('bg-primary').text('Preparing');
            card.find('.cancel-btn').remove(); // Xóa nút Hủy khi bắt đầu chuẩn bị
            list.prepend(card); // Đưa lên đầu danh sách Preparing
            $("#preparing-empty").remove();
        });

        // 3. OrderReady: Bartender hoàn thành -> Di chuyển từ Preparing sang Ready
        orderHub.on("OrderReady", (orderDto) => {
            // Render lại card để thêm nút Confirm
            const card = $(`#order-${orderDto.orderId}`);
            card.remove(); // Loại bỏ card cũ
            const newCard = renderOrderCard(orderDto, 'Waiter');
            const list = $("#ready-list");

            list.prepend(newCard); // Đưa lên đầu danh sách Ready
            $("#ready-empty").remove();
        });

        // 4. OrderConfirmed: Waiter xác nhận đã giao hàng -> Loại bỏ khỏi tất cả cột
        orderHub.on("OrderConfirmed", (orderDto) => {
            $(`#order-${orderDto.orderId}`).fadeOut(300, function() {
                $(this).remove();
            });
            // Có thể thêm logic kiểm tra xem các cột có rỗng không
        });

        // 5. OrderCanceled: Đơn bị hủy -> Loại bỏ khỏi tất cả cột
        orderHub.on("OrderCanceled", (orderId) => {
            $(`#order-${orderId}`).fadeOut(300, function() {
                $(this).remove();
            });
        });

    </script>
}

