@using CafeManagent.dto.response.OrderModuleDTO
@model OrderDto
@{
    // Lấy vai trò (Role) từ ViewData để quyết định hiển thị nút
    var role = ViewData["Role"]?.ToString();

    int status = Model.Status ?? 0;

    // Đảm bảo tên khách hàng hiển thị là "Khách vãng lai" nếu không có tên cụ thể (Logic đã fix)
    string customerNameDisplay = Model.CustomerName;

    // Logic CSS cho badge trạng thái
    string badgeClass = status switch
    {
        -2 => "bg-danger", // ĐÃ HOÀN TIỀN
        -1 => "bg-danger", // ĐÃ HỦY
        0 => "bg-warning text-dark", // CHỜ
        1 => "bg-primary", // ĐANG CHUẨN BỊ
        2 => "bg-success", // ĐÃ SẴN SÀNG
        3 => "bg-secondary", // HOÀN THÀNH
        _ => "bg-info"
    };

    var formattedAmount = Model.TotalAmount?.ToString("N0", new System.Globalization.CultureInfo("vi-VN")) ?? "0";
}

<tr class="order-row" id="order-@Model.OrderId" data-status="@status">
    <th scope="row">#@Model.OrderId</th>
    <td>@customerNameDisplay</td>
    <td><strong data-amount="@(Model.TotalAmount)">@formattedAmount VND</strong></td>
    <td>@Model.OrderTime</td>
    <td>
        <span class="badge @badgeClass">@Model.StatusText</span>
    </td>
    <td class="text-end" data-order-status="@Model.Status">
       
        <a href="/Order/Details/@Model.OrderId" class="btn btn-sm btn-info me-1" title="Xem chi tiết"><i class="fa-solid fa-eye"></i></a>

        @if (role == "Waiter")
        {
            @if (Model.Status == 0) // Chờ
            {
                <button class="btn btn-sm btn-danger cancel-btn" data-id="@Model.OrderId" data-bs-toggle="modal" data-bs-target="#confirmCancelModal" title="Hủy đơn"><i class="fa-solid fa-xmark"></i> Hủy</button>
            }
            else if (Model.Status == 2) // Đã sẵn sàng
            {
                <button class="btn btn-sm btn-success confirm-btn" data-id="@Model.OrderId" data-bs-toggle="modal" data-bs-target="#confirmWaiterModal" title="Xác nhận giao hàng & thanh toán">
                    <i class="fa-solid fa-check"></i> Xác nhận
                </button>
            }
        }
        else if (role == "Bartender")
        {
            @if (Model.Status == 0) // Chờ
            {
                // Note: Các nút Bartender thường dùng Modal để xác nhận, nhưng tôi giữ theo logic cũ của bạn.
                // Nếu muốn dùng Modal, bạn cần thay prepare-btn bằng action-btn và thêm data-bs-toggle/data-bs-target.
                <button class="btn btn-sm btn-primary prepare-btn" data-id="@Model.OrderId" title="Bắt đầu chuẩn bị">
                    <i class="fa-solid fa-play"></i> Bắt đầu
                </button>
            }
            else if (Model.Status == 1) // Đang chuẩn bị
            {
                <button class="btn btn-sm btn-success ready-btn" data-id="@Model.OrderId" data-bs-toggle="modal" data-bs-target="#confirmBartenderModal" title="Hoàn thành đơn">
                    <i class="fa-solid fa-check"></i> Hoàn thành
                </button>
            }
            // --- ĐIỂM SỬA CHỮA: Hiển thị trạng thái Đã sẵn sàng (Status 2) không có nút Action ---
            else if (Model.Status == 2) // Đã sẵn sàng
            {
                <button class="btn btn-sm btn-light text-muted" disabled title="Chờ Waiter xác nhận giao">
                    <i class="fa-solid fa-mug-hot"></i> Đã làm xong
                </button>
            }
        }
        else if (role == "History") // Logic mới cho màn hình Lịch sử (AllHistory)
        {
            // Chỉ cho phép Hoàn tiền đơn Đã hoàn thành (Status 3)
            if (Model.Status == 3)
            {
                <button class="btn btn-sm btn-danger refund-btn" data-id="@Model.OrderId" data-bs-toggle="modal" data-bs-target="#confirmRefundModal" title="Hoàn tiền và chuyển trạng thái">
                    <i class="fa-solid fa-undo"></i> Hoàn tiền
                </button>
            }
        }
    </td>
</tr>