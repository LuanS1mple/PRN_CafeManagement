@using CafeManagent.dto.request.StaffModuleDTO;
@model UpdateStaffProfile
@{
    ViewData["Title"] = "Sửa hồ sơ";
    var avatar = (string?)(ViewBag.Avatar ?? "/images/avatars/default.png");
    var activeTab = (string?)ViewBag.ActiveTab ?? "info";   // 👈 tab đang active
}

<link rel="stylesheet" href="~/css/EditProfile.css?v=2" />

<div class="container profile-wrap">
    <div class="profile-grid">

        <!-- LEFT CARD -->
        <aside class="card left-card">
            <div class="avatar-wrap">
                @{
                    var bust = DateTimeOffset.UtcNow.Ticks;
                }
                <img class="avatar-circle" id="avatarPreview" src="@avatar?v=@bust" alt="Avatar" />
            </div>

            <label class="btn btn-upload" for="avatarFile">
                <span class="icon-up">⌃</span> Tải ảnh lên
            </label>

            <!-- input này thuộc form THÔNG TIN -->
            <input id="avatarFile" type="file" name="avatarFile" accept="image/*"
                   style="display:none" form="tab-info" />

            <div class="label" style="margin-top:8px;">PNG/JPG/WEBP ≤ 2MB</div>
        </aside>

        <!-- RIGHT CARD -->
        <section class="card right-card">

            <!-- TABS -->
            <div class="tabs">
                <span class="tab @(activeTab == "info" ? "active" : "")" data-tab="info">Thông tin</span>
                <span class="tab @(activeTab == "security" ? "active" : "")" data-tab="security">Bảo mật</span>
            </div>

            <!-- ============= TAB 1: THÔNG TIN ============= -->
            <form id="tab-info"
                  asp-controller="StaffProfile"
                  asp-action="Edit"
                  asp-route-id="@Model.StaffId"
                  method="post"
                  enctype="multipart/form-data"
                  class="tab-panel @(activeTab == "info" ? "active" : "")">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="StaffId" />

                <div asp-validation-summary="All" class="val-summary"></div>

                <div class="kv2">
                    <div class="kv2-row">
                        <div class="kv2-label">Họ và tên</div>
                        <div class="kv2-value">
                            <input class="input" asp-for="FullName" />
                            <span asp-validation-for="FullName" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="kv2-row">
                        <div class="kv2-label">Giới tính</div>
                        <div class="kv2-value">
                            <select class="input" asp-for="Gender">
                                <option value="">—</option>
                                <option value="true">Nam</option>
                                <option value="false">Nữ</option>
                            </select>
                            <span asp-validation-for="Gender" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="kv2-row">
                        <div class="kv2-label">Ngày sinh</div>
                        <div class="kv2-value">
                            <input class="input" asp-for="BirthDate" type="date" />
                            <span asp-validation-for="BirthDate" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="kv2-row">
                        <div class="kv2-label">Email</div>
                        <div class="kv2-value">
                            <input class="input" asp-for="Email" />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="kv2-row">
                        <div class="kv2-label">Điện thoại</div>
                        <div class="kv2-value">
                            <input class="input" asp-for="Phone" />
                            <span asp-validation-for="Phone" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="kv2-row">
                        <div class="kv2-label">Địa chỉ</div>
                        <div class="kv2-value">
                            <input class="input" asp-for="Address" />
                            <span asp-validation-for="Address" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <a class="btn secondary"
                       asp-controller="StaffProfile"
                       asp-action="Profile"
                       asp-route-id="@Model.StaffId">
                        Hủy
                    </a>
                    <button class="btn primary" type="submit">Lưu thay đổi</button>
                </div>
            </form>

            <!-- ============= TAB 2: BẢO MẬT ============= -->
            <form id="tab-security"
                  asp-controller="StaffProfile"
                  asp-action="ChangePassword"
                  method="post"
                  class="tab-panel @(activeTab == "security" ? "active" : "")">
                @Html.AntiForgeryToken()
                <input type="hidden" name="StaffId" value="@Model.StaffId" />

                <h3>Đổi mật khẩu</h3>

                <div asp-validation-summary="All" class="val-summary"></div>

                <div class="kv2" style="max-width:350px;">
                    <div class="kv2-row">
                        <div class="kv2-label">Mật khẩu hiện tại</div>
                        <div class="kv2-value">
                            <input class="input" type="password" name="CurrentPassword" required />
                        </div>
                    </div>

                    <div class="kv2-row">
                        <div class="kv2-label">Mật khẩu mới</div>
                        <div class="kv2-value">
                            <input class="input" type="password" name="NewPassword" minlength="6" required />
                        </div>
                    </div>

                    <div class="kv2-row">
                        <div class="kv2-label">Xác nhận mật khẩu</div>
                        <div class="kv2-value">
                            <input class="input" type="password" name="ConfirmPassword" minlength="6" required />
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn primary" type="submit">Đổi mật khẩu</button>
                </div>
            </form>

        </section>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Preview avatar
        const fileInput = document.getElementById('avatarFile');
        const avatar = document.getElementById('avatarPreview');
        if (fileInput && avatar) {
            fileInput.addEventListener('change', (e) => {
                const f = e.target.files?.[0];
                if (!f) return;
                avatar.src = URL.createObjectURL(f);
            });
        }

        // TAB SWITCHING
        const tabs = document.querySelectorAll(".tab");
        const panels = document.querySelectorAll(".tab-panel");

        tabs.forEach(tab => {
            tab.addEventListener("click", () => {
                tabs.forEach(t => t.classList.remove("active"));
                tab.classList.add("active");

                panels.forEach(p => p.classList.remove("active"));
                const panelId = "tab-" + tab.dataset.tab;
                const panel = document.getElementById(panelId);
                if (panel) panel.classList.add("active");
            });
        });
    </script>
}
